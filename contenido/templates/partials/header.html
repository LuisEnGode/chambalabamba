{% load static %}
<header class="header-style-2">
    <nav class="navbar navbar-expand-lg">

        <a class="navbar-brand"  href="{% url 'home' %}"></a>
            <!--
            <img src="{% static 'images/logo/logo-chambalabamba-small.png' %}" alt="">
             -->
        </a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <i class="fas fa-bars"></i>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">

                <li class="nav-item">
                    <a class="nav-link" href="{% url 'home' %}">Inicio</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                        Nosotros
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="{% url 'nosotros:nuestro_camino' %}">Nuestro camino</a></li>
                        <!-- Pilares con submen√∫ -->
                        <li class="dropdown-submenu">
                            <a class="dropdown-item dropdown-toggle" href="#">Pilares</a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="{% url 'nosotros:pilar_detail' slug='ecologia' %}">Ecolog√≠a</a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'nosotros:pilar_detail' slug='economia' %}">Econom√≠a
                                        comunitaria
                                    </a></li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'nosotros:pilar_detail' slug='bienestar' %}">Bienestar
                                        integral
                                    </a></li>
                                
                                <li class="dropdown-submenu position-relative">
                                  <a class="dropdown-item dropdown-toggle" href="#" data-toggle="dropdown">
                                    Sociocultural
                                  </a>
                                  <ul class="dropdown-menu">
                                    <li>
                                      <a class="dropdown-item" href="{% url 'nosotros:pilar_detail' slug='sociocultural' %}">
                                        Ver secci√≥n Sociocultural
                                      </a>
                                    </li>
                                    <li>
                                      <a class="dropdown-item" href="{% url 'eventos:escuela_viva' %}">
                                        Escuela viva
                                      </a>
                                    </li>
                                  </ul>
                                </li>
                            </ul>
                        </li>

                        <li><a class="dropdown-item" href="{% url 'nosotros:topic_detail' slug='gobernanza'  %}">Gobernanza</a>
                        </li>
                        <li><a class="dropdown-item" href="{% url 'nosotros:topic_detail' slug='principios_valores' %}">Principios
                            y valores</a></li>
                        <li><a class="dropdown-item" href="{% url 'nosotros:topic_detail' slug='territorio' %}">Territorio</a>
                        </li>
                        <li>
                            <a class="dropdown-item"
                               href="{% url  'coops:lista' %}">Cooperaciones</a>
                        </li>
                    </ul>
                </li>


                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                        Eventos
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="{% url 'eventos:talleres' %}">Talleres</a></li>
                        <li><a href="{% url 'eventos:retiros' %}">Retiros</a></li>
                        <li><a href="{% url 'eventos:artes' %}">Artes</a></li>
                        <li><a href="{% url 'eventos:terapias' %}">Terapias</a></li>
                        <li><a href="{% url 'eventos:festivales' %}">Festivales</a></li>
                    </ul>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                        Participa
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="{% url 'participa:voluntariado' %}">Voluntariado</a></li>
                        <li><a href="{% url 'participa:estancias' %}">Estancias</a></li>
                        <li><a href="{% url 'visitas:visitas-guiadas' %}">Visitas guiadas</a></li>
                        <li><a href="{% url 'tienda:tienda' %}">Tienda comunitaria</a></li>
                        <li><a href="{% url 'donaciones' %}">Donaciones</a></li>
                    </ul>
                </li>

                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown">Blog</a>
                  <ul class="dropdown-menu">
                    <li><a href="{% url 'blog_list' %}">Ver Posts</a></li>

                      <li> <a href="{% url 'blog_public_create' %}">Enviar un post</a></li>
                  </ul>
                </li>


                <li class="nav-item">
                    <a class="nav-link" href="{% url 'contacto:contacto' %}">Contacto</a>
                </li>

                <!-- üåç Language Selector -->
                <li class="nav-item position-relative">
                <a href="#" id="lang-toggle" class="nav-link">
                    <i class="fas fa-globe"></i>
                </a>

                <!-- Language menu -->
                <div id="lang-menu" class="lang-menu dropdown-menu">
                    <button data-lang="es" class="lang-btn dropdown-item">Espa√±ol</button>
                    <button data-lang="en" class="lang-btn dropdown-item">English</button>
                    <button data-lang="fr" class="lang-btn dropdown-item">Fran√ßais</button>
                    <button data-lang="it" class="lang-btn dropdown-item">Italiano</button>
                </div>

                <!-- Loading spinner -->
                <div id="lang-loading" class="lang-loading" style="display:none;">
                    <div class="spinner"></div>
                </div>

                <!-- Hidden official GTranslate widget -->
                <div id="google_translate_element" class="gtranslate_wrapper" style="display:none;"></div>

                <script>
                    window.gtranslateSettings = {
                    default_language: "es",
                    detect_browser_language: true,
                    languages: ["es", "fr", "it", "en"],
                    wrapper_selector: ".gtranslate_wrapper"
                    };

                    // define init for Google Translate script
                    window.googleTranslateElementInit2 = function () {
                    new window.google.translate.TranslateElement(
                        { pageLanguage: "es", autoDisplay: false },
                        "google_translate_element"
                    );
                    };
                </script>

                <!-- Load official GTranslate dropdown -->
                <script src="https://cdn.gtranslate.net/widgets/latest/dropdown.js" defer></script>
                </li>

            </ul>

        </div>

    </nav>
</header>

<!-- Buscador Overlay -->
<div id="search">
    <button type="button" class="close">√ó</button>
    <form class="search-overlay-form">
        <input type="search" value="" placeholder="Buscar palabras clave..."/>
        <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i></button>
    </form>
</div>

<style>
    /* Language dropdown similar to Bootstrap nav dropdowns */
    .lang-menu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        min-width: 160px;
        background: white;
        border: 1px solid rgba(0,0,0,0.15);
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.175);
        z-index: 1000;
        padding: 0.25rem 0;
    }

    .lang-btn {
        display: block;
        width: 100%;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: #212529;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
    }

    .lang-btn:hover {
        background-color: #f8f9fa;
    }

    /* Spinner overlay */
    .lang-loading {
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 0.25rem;
        z-index: 2000;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #333;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<!-- === MAIN MULTI-BROWSER TRANSLATION HANDLER === -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("lang-toggle");
  const menu = document.getElementById("lang-menu");
  const loading = document.getElementById("lang-loading");
  const defaultLang = window.gtranslateSettings.default_language || "es";

  // --- üß† 1. Set auto cookie before GT loads (for Chrome/Edge auto-detect) ---
  (function initAutoCookie() {
    const domain = window.location.hostname;
    const hasCookie = document.cookie.includes("googtrans=");
    if (!hasCookie) {
      const browserLang = navigator.language.slice(0, 2) || defaultLang;
      document.cookie = `googtrans=/auto/${browserLang};path=/;`;
      document.cookie = `googtrans=/auto/${browserLang};path=/;domain=${domain}`;
    }
  })();

  // --- üß© 2. Dropdown toggle logic ---
  toggle.addEventListener("click", (e) => {
    e.preventDefault();
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  });

  document.addEventListener("click", (e) => {
    if (!menu.contains(e.target) && !toggle.contains(e.target)) {
      menu.style.display = "none";
    }
  });

  // --- ‚öôÔ∏è 3. Ensure GT script availability ---
  const ensureTranslateScript = () =>
    new Promise((resolve) => {
      const needReload =
        !window.google ||
        !window.google.translate ||
        typeof window.google.translate.TranslateElement !== "function";

      if (!needReload) {
        resolve();
        return;
      }

      delete window.google;

      const script = document.createElement("script");
      script.src =
        "https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit2";
      window.googleTranslateElementInit2 = () => {
        new window.google.translate.TranslateElement(
          { pageLanguage: defaultLang, autoDisplay: false },
          "google_translate_element"
        );
        resolve();
      };
      document.body.appendChild(script);
    });

  // --- üîÑ 4. Normalize cookie on page load ---
  const normalizeCookie = () => {
    const googtransCookie = document.cookie
      .split("; ")
      .find((row) => row.startsWith("googtrans="));
    if (googtransCookie) {
      const value = googtransCookie.split("=")[1];
      const parts = value.split("/");
      if (parts[1] === "auto") {
        const domain = window.location.hostname;
        document.cookie = `googtrans=/${defaultLang}/${parts[2]};path=/;`;
        document.cookie = `googtrans=/${defaultLang}/${parts[2]};path=/;domain=${domain}`;
      }
    }
  };
  normalizeCookie();

  // --- üåç 5. Handle language switching ---
  document.querySelectorAll(".lang-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      loading.style.display = "flex";
      menu.style.display = "none";

      const targetLang = btn.dataset.lang;
      await ensureTranslateScript();

      const domain = window.location.hostname;

      if (targetLang === defaultLang) {
        // Reset to default (Spanish)
        const googtransCookie = document.cookie
          .split("; ")
          .find((row) => row.startsWith("googtrans="));
        let currentLang = defaultLang;
        if (googtransCookie) {
          const value = googtransCookie.split("=")[1];
          const parts = value.split("/");
          currentLang = parts[2] || defaultLang;
        }

        if (typeof window.doGTranslate === "function") {
          window.doGTranslate(`${currentLang}|${defaultLang}`);
        }

        // Reset cookie to /auto/es
        document.cookie = `googtrans=/auto/${defaultLang};path=/;`;
        document.cookie = `googtrans=/auto/${defaultLang};path=/;domain=${domain}`;

        loading.style.display = "none";
        return;
      }

      // Translate from default to target
      document.cookie = `googtrans=/${defaultLang}/${targetLang};path=/;`;
      document.cookie = `googtrans=/${defaultLang}/${targetLang};path=/;domain=${domain}`;

      const doTranslate = () => {
        if (typeof window.doGTranslate === "function") {
          window.doGTranslate(`${defaultLang}|${targetLang}`);
          loading.style.display = "none";
        } else {
          setTimeout(doTranslate, 200);
        }
      };
      doTranslate();
    });
  });

  // --- üí° 6. Backup loader for Chrome/Edge (in case GT doesn't initialize) ---
  setTimeout(() => {
    if (
      !window.google ||
      !window.google.translate ||
      typeof window.google.translate.TranslateElement !== "function"
    ) {
      const script = document.createElement("script");
      script.src =
        "https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit2";
      document.body.appendChild(script);
    }
  }, 1500);
});
</script>
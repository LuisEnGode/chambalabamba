{% extends "core/base.html" %}
{% load static %}
{% block title %}{{ page.title }} – Chambalabamba{% endblock %}
{% block content %}
<!--Inner Header Start-->
<section class="wf100 p100 inner-header"
         style="background-image: url({% if page.header and page.header.background %}{{ page.header.background.url }}{% else %}{% static 'images/innerheader.jpg' %}{% endif %}); background-size: cover; background-position: center;">
    <div class="container">
        <h1>{% if page.header and page.header.title %}{{ page.header.title }}{% else %}Nosotros{% endif %}</h1>
        <ul>
            <li><a href="{% url 'home' %}">Inicio</a></li>
            <li><a href="{% url 'blog_list' %}">Blog</a></li>
            <li><a href="#">{% if page.header and page.header.breadcrumb_label %}{{ page.header.breadcrumb_label }}{% else %}Blog{% endif %}</a></li>
        </ul>
    </div>
</section>
<!--Inner Header End-->
<!--Blog Start-->
{% load static %}

<section class="wf100 p80 blog">
    <div class="blog-details">
        <div class="container">
            <div class="row">
                <!-- Columna principal -->
                <div class="col-lg-9 col-md-8">
                    <div class="blog-single-content">

                        {# Imagen/galería de cabecera #}
                        {% if post.header_image %}
                        <div class="blog-single-thumb text-center">
                          <img src="{{ post.header_image.url }}" alt="{{ post.titulo }}" class="img-fluid mx-auto d-block" style="max-width: 420px;" loading="lazy">
                        </div>
                        {% endif %}

                        <h3>{{ post.titulo }}</h3>
                        {% if can_edit %}
                          <p>
                            <a class="btn btn-sm btn-outline-primary" href="{% url 'blog_update' slug=post.slug %}">
                              ✏️ Editar este post
                            </a>
                          </p>
                        {% endif %}

                        <ul class="post-meta">
                            {% if post.autor %}
                            <li><i class="fas fa-user-circle"></i>
                                <a href="{% url 'blog_by_author' slug=post.autor.slug %}">{{ post.autor.nombre }}</a>
                            </li>
                            {% endif %}
                            <li><i class="fas fa-calendar-alt"></i> {{ post.fecha_publicacion|date:"d M, Y" }}</li>
                            <li><i class="fas fa-comments"></i> {{ post.comentarios_count }} Comentarios</li>
                            {% if post.tags.all %}
                            <li class="tags"><i class="fas fa-tags"></i>
                                {% for t in post.tags.all %}
                                <a href="{% url 'blog_by_tag' slug=t.slug %}">{{ t.nombre }}</a>{% if not forloop.last %} {% endif %}
                                {% endfor %}
                            </li>
                            {% endif %}
                        </ul>

                        {# Cuerpo del post #}
                        {% if post.cuerpo_html %}
                        <div class="post-body">{{ post.cuerpo_html|safe }}</div>
                        {% elif post.resumen %}
                        <p>{{ post.resumen|safe }}</p>
                        {% endif %}

                        {# Mini galería opcional (primeras 3) #}
                        {% with thumbs=post.fotos.all %}
                        {% if thumbs %}
                        <ul class="small-gallery">
                            {% for f in thumbs|slice:":3" %}
                            <li><img src="{{ f.imagen.url }}" alt="{{ f.alt|default:post.titulo }}"></li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% endwith %}

                        {# Tags (chips) #}
                        {% if post.tags.all %}
                        <div class="single-post-tags wf100">
                            {% for t in post.tags.all %}
                            <a href="{% url 'blog_by_tag' slug=t.slug %}">{{ t.nombre }}</a>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {# Caja de autor #}
                        {% if post.autor %}
                        <div class="author-box wf100">
                            {% if post.autor.foto %}
                            <img src="{{ post.autor.foto.url }}" alt="{{ post.autor.nombre }}">
                            {% endif %}
                            <h5>Sobre el autor</h5>
                            <p><strong>{{ post.autor.nombre }}</strong></p>
                            {% if post.autor.bio %}<p>{{ post.autor.bio }}</p>{% endif %}

                        </div>
                        {% endif %}

                        {# Comentarios visibles (aprobados) #}
                            <h4>Comentarios ({{ comentarios|length }})</h4>
                            <ul class="comments">
                                {% for c in comentarios %}
                                {% if not c.parent_id %}
                                <li id="comment-{{ c.id }}" class="comment">
                                    <div class="user-thumb">
                                        <img src="{% static 'images/auser.jpg' %}" alt="">
                                    </div>
                                    <div class="comment-txt">
                                        <h6>
                                            {{ c.nombre|default:'Anónimo' }}
                                            {% if c.website %}
                                                <small> · <a href="{{ c.website }}" target="_blank" rel="nofollow noopener noreferrer">web</a></small>
                                            {% endif %}

                                        </h6>
                                        <p>{{ c.cuerpo|linebreaks }}</p>
                                        <ul class="comment-time">
                                            <li>Publicado: {{ c.creado|date:"d M, Y H:i" }}</li>
                                            <li><a href="#comment-form" class="reply-link" data-parent="{{ c.id }}"><i class="fas fa-reply"></i> Responder</a></li>
                                        </ul>
                                        <div class="reply-slot"></div>  {# <- lugar donde se inserta el form #}
                                        {% if c.replies.all %}
                                        <ul class="children">
                                          {% for r in c.replies.all %}
                                            <li id="comment-{{ r.id }}" class="comment"> ... </li>
                                          {% endfor %}
                                        </ul>
                                        {% endif %}
                                    </div>

                                    {# Respuestas aprobadas #}
                                    {% if c.replies.all %}
                                    <ul class="children">
                                        {% for r in c.replies.all %}
                                        {% if r.status == "approved" %}
                                        <li class="comment">
                                            <div class="user-thumb"><img src="{% static 'images/auser.jpg' %}" alt="">
                                            </div>
                                            <div class="comment-txt">
                                                <h6>{{ r.nombre|default:r.user.get_full_name|default:r.user.get_username|default:'Anónimo' }}</h6>
                                                <p>{{ r.cuerpo|linebreaks }}</p>
                                                <ul class="comment-time">
                                                    <li>Publicado: {{ r.creado|date:"d M, Y H:i" }}</li>
                                                </ul>
                                            </div>
                                        </li>
                                        {% endif %}
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </li>
                                {% endif %}
                                {% empty %}
                                <li class="text-muted">Sé el primero en comentar.</li>
                                {% endfor %}
                            </ul>
                        </div>

                        {# Formulario para comentar #}
                        <div class="wf100 comment-form">
                            <h4>Deja un comentario</h4>
                            <form id="comment-form" action="{% url 'blog_detail' slug=post.slug %}" method="post">
                                {% csrf_token %}
                                {{ form.non_field_errors }}
                                {{ form.parent }} {# <-- importante #}
                                {{ form.hp }} {# honeypot #}
                                <ul>
                                    <li class="w3">{{ form.nombre }}</li>
                                    <li class="w3">{{ form.email }}</li>
                                    <li class="w3 np">{{ form.website }}</li>
                                    <li class="full">{{ form.cuerpo }}</li>
                                    <li class="full">
                                        <button id="comment-submit"
                                              class="post-btn"
                                              type="submit"
                                              data-default="ENVIAR"
                                              data-loading="Enviando…"
                                              aria-live="polite">
                                              ENVIAR
                                            </button>
                                        <a id="cancel-reply" href="#" style="display:none;margin-left:10px">Cancelar respuesta</a>
                                    </li>
                                </ul>
                            </form>
                        </div>

                        {# Relacionados #}
                        {% if related %}
                        <div class="wf100 related-posts">
                            <h4>Posts relacionados</h4>
                            <ul>
                                {% for p in related %}
                                <li>
                                    <div class="rp-box">
                                        <h6><a href="{% url 'blog_detail' slug=p.slug %}">{{ p.titulo }}</a></h6>
                                        <ul class="post-meta">
                                            <li><i class="fas fa-calendar-alt"></i> {{ p.fecha_publicacion|date:"d M, Y" }}
                                            </li>
                                            <li><i class="fas fa-comments"></i> {{ p.comentarios_count }} Comentarios
                                            </li>
                                        </ul>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                    </div>
                </div>

                <!-- Sidebar (usa los mismos widgets que la lista) -->
                <div class="col-lg-3 col-md-4">
                    <div class="sidebar">
                        {% for w in widgets %}
                        <div class="side-widget {% if w.tipo == 'text' %}text-widget{% endif %}">
                            {% if w.titulo %}<h5>{{ w.titulo }}</h5>{% endif %}

                            {% if w.tipo == "search" %}
                            <div class="side-search">
                                <form method="get" action="{% url 'blog_list' %}">
                                    <input type="search" name="q" class="form-control" placeholder="Buscar">
                                    <button><i class="fas fa-search"></i></button>
                                </form>
                            </div>
                            {% elif w.tipo == "text" %}
                            <p>{{ w.body_html|safe }}</p>
                            {% elif w.tipo == "latest_posts" %}
                            <ul class="lastest-products">
                                {% for p in latest_posts %}
                                {% if forloop.counter0 < w.limite %}
                                <li>
                                    {% if p.header_image %}
                                    <img src="{{ p.header_image.url }}" alt="{{ p.titulo }}"
                                         style="width:64px;height:64px;object-fit:cover;border-radius:6px;">
                                    {% endif %}
                                    <strong><a href="{% url 'blog_detail' slug=p.slug %}">{{ p.titulo }}</a></strong>
                                    <span class="pdate"><i class="fas fa-calendar-alt"></i> {{ p.fecha_publicacion|date:"d M, Y" }}</span>
                                </li>
                                {% endif %}
                                {% empty %}
                                <li class="text-muted">No hay publicaciones recientes.</li>
                                {% endfor %}
                            </ul>
                            {% elif w.tipo == "tags" %}
                            <div class="single-post-tags">
                                {% for t in all_tags %}
                                <a href="{% url 'blog_by_tag' slug=t.slug %}">{{ t.nombre }}</a>
                                {% endfor %}
                            </div>
                            {% elif w.tipo == "archives" %}
                            <ul>
                                {% for d in archives %}
                                <li><a href="{% url 'blog_by_month' year=d|date:'Y' month=d|date:'n' %}">{{ d|date:"F Y" }}</a></li>
                                {% endfor %}
                            </ul>
                            {% elif w.tipo == "cta_volunteer" %}
                            <h5><a href="{{ w.link_url|default:page.volunteer_url }}">{{ w.link_label|default:'Súmate' }}</a></h5>
                            {% elif w.tipo == "cta_donate" %}
                            <div class="donation-amount">
                                <h5><a href="{{ w.link_url|default:page.donate_url }}">{{ w.link_label|default:'Dona'
                                    }}</a></h5>
                            </div>
                            {% elif w.tipo == "custom_html" %}
                            {{ w.body_html|safe }}
                            {% endif %}
                        </div>
                        {% empty %}
                        <p class="text-muted">Sin widgets configurados.</p>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

{# Responder a un comentario (rellena el hidden "parent") #}
<script>
    document.addEventListener('click', function (e) {
      const a = e.target.closest('.reply-link');
      if (!a) return;
      e.preventDefault();
      const inp = document.querySelector('form [name="parent"]');
      if (inp) { inp.value = a.dataset.parent; inp.scrollIntoView({behavior:'smooth'}); }
    });
</script>

<script>
(function () {
  const form = document.getElementById('comment-form');
  if (!form) return;

  const parentInput = form.querySelector('[name="parent"]');
  const cancel = document.getElementById('cancel-reply');

  // Guardamos el lugar original del form
  const home = document.createElement('div');
  home.id = 'comment-form-home';
  form.parentNode.insertBefore(home, form);

  function moveFormTo(commentId) {
    const li = document.getElementById('comment-' + commentId);
    if (!li) return;
    const slot = li.querySelector('.reply-slot') || li;
    slot.appendChild(form);
    cancel.style.display = 'inline-block';
  }

  function resetFormPosition() {
    parentInput.value = '';
    home.parentNode.insertBefore(form, home.nextSibling);
    cancel.style.display = 'none';
  }

  // Click en “Responder”
  document.addEventListener('click', function (e) {
    const a = e.target.closest('.reply-link');
    if (!a) return;
    e.preventDefault();
    const id = a.getAttribute('data-parent');
    parentInput.value = id;
    moveFormTo(id);
    form.scrollIntoView({behavior: 'smooth', block: 'center'});
  });

  // Cancelar respuesta
  cancel.addEventListener('click', function (e) {
    e.preventDefault();
    resetFormPosition();
    form.scrollIntoView({behavior: 'smooth', block: 'center'});
  });
})();
</script>

<!--Blog End-->
<!--Footer Start-->
{% endblock %}